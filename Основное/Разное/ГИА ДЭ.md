— Перейти в [[HUB]] —
— Перейти к заданию [[КОД 09.02.06-1-2026 Том 1.pdf]] —

---
## Модуль 1. Настройка сетевой инфраструктуры


## Модуль 2. Организация сетевого администрирования
---
1. [[#Настройка контроллера домена Samba DC на BR-SRV]]
2. [[#Конфигурация файлового хранилища на HQ-SRV]]
3. [[#Настройка NFS-Server на HQ-SRV]]
4. [[#Настройка службы сетевого времени]]
5. [[#Конфигурация Ansible на BR-SRV]]
6. [[#Настраиваем Docker на BR-SRV]]
7. [[#Развертывания веб-приложения на HQ-SRV]]
8. [[#На маршрутизаторах конфигурируем статическую трансляцию портов]]
9. [[#Настройка обратного прокси на ISP]]
10. [[#Настройка web-based аутентификации на ISP]]
---
### Настройка контроллера домена Samba DC на BR-SRV:
```bash
apt-get update && apt-get install task-samba-dc -y
```
Очищаем базы и конфигурацию Samba:
```bash
rm -f /etc/samba/smb.conf
rm -rf /var/lib/samba/
rm -rf /var/cache/samba
mkdir -p /var/lib/samba/sysvol
```
Запускаем службу:
```bash
systemctl enable --now samba
```
Настраиваем Kerberos:
```bash
cp /var/lib/samba/private/krv5.conf /etc/krb5.conf
```
Перезапускаем службу:
```bash
systemctl start samba
```
После этого, проверяем Kerberos:
```bash
kinit administartor@AU-TEAM.IRPO
```
Когда билет получен (без ошибок), можем приступать к следующим шагам. Создадим группу HQ:
```bash
samba-tool group hq
```
После чего, создадим 5 пользователей:
```bash
for i in {1..5}; do
    samba-tool user create hquser$i 'P@ssw0rd'
    samba-tool group addmembers hq hquser$i
done
```
Ограничение набора команд (с hq-cli):
```bash
echo "%hq@au-team.irpo ALL=(root) /bin/cat, /bin/grep, /bin/id" >> /etc/sudoers
echo "%hq@au-team.irpo ALL=(root) !/bin/sh, !/bin/bash, !/usr/bin/sudo -i, !/usr/bin/sudo su" >> /etc/sudoers
```
Убедиться в том, что авторизация работает можно при помощи команды:
```bash
getent passwd hquser№
su - hquser№
```

### Конфигурация файлового хранилища на HQ-SRV
Создание RAID0
```bash
mdadm --create /dev/md0 --level=0 --raid-devices=2 /dev/sdb /dev/sdc
```
Сохраняем конфигурацию: 
```bash
mdadm --detail --scan >> /etc/mdadm.conf
update-initramfs -u
```
Создаем файловую систему ext4:
```bash
mkfs.ext4 /dev/md0
```
Монтируем:
```bash
mkdir -p /raid
vim /etc/fstab
> /dev/md0 /raid ext4 defaults 0 0
mount -a
```

### Настройка NFS-Server на HQ-SRV 
```bash
apt-get update && apt-get install nfs-server -y
```
Создаем папку
```bash
mkdir -p /raid/nfs
chmod 777 /raid/nfs
```
Затем, заходим в `/etc/exports` и добавляем следующую строку:
```bash
/raid/nfs 192.168.2.0/28(rw,sync,no_subtree_check,no_root_squash)
```
Применяем изменения:
```bash
exportfs -ra
```

### Настройка службы сетевого времени
Конфигурация на ISP
```bash
vim /etc/chrony.conf

server ntp0.ntp-servers.net iburst prefer minstratum 4
allow 0.0.0.0/0
local stratum 5
```
На всех остальных устройствах, меняем первую строку с pool:
```bash
server ISP-IP iburst
```
На каждом устройстве:
```bash
systemctl restart chronyd
chronyc sources # на клиентах
```

### Конфигурация Ansible на BR-SRV
```bash
apt-get update && apt-get install ansible -y
```
Переходим в рабочую директорию:
```bash
cd /etc/ansible/
```
В `ansible.cfg` расскоментируем и поменяем следующую строку:
```bash
inventory = /etc/ansible/hosts
```
Следующим файлом, который нам нужно заполнить `hosts`:
```bash
[all_hosts]
HQ-SRV ansible_host=192.168.1.10
HQ-CLI ansible_host=192.168.2.10
HQ-RTR ansible_host=192.168.1.1
BR-RTR ansible_host=192.168.3.1

[all:vars]
ansible_user=root
ansible_password=toor
ansible_python_interpreter=/usr/bin/python3
```
После чего, проверим:
```bash
ansible -m ping all
```
Если у вас по какой-либо из причин лезет `unreacheable` и жалуется на SSH. Заходим на каждое устройство и в файле /etc/openssh/sshd_config, раскоментируем и меняем следующее:
```bash
Port=22
PermitRootLogin=yes
PasswordAuthentication=yes
```
Перезапускаем службу:
```bash
systemctl restart sshd
```

### Настраиваем Docker на BR-SRV
```bash
apt-get update && apt-get install docker-engine docker-compose-v2
```
Примонтируем additional.iso:
```bash
mount /dev/sr0 /mnt
```
Создаем отдельную рабочую директорию:
```bash
mkdir -p /opt/webapp && cd !$
```
Импортируем docker-образ из tar-архива:
```bash
docker load -i /mnt/docker/mariadb_latest.tar
docker load -i /mnt/docker/site_latest.tar
```
Проверяем:
```bash
docker images
> Появятся mariadb 10.11 и site latest
```
Создаем и заходим в конфигурационный файл `docker-compose.yml`:
```bash
services:
	database:
		image: mariadb:10.11
		container_name: db
		restart: always
		environmnt:
			MARIADB_ROOT_PASSWORD: "toor"
			MARIADB_DATABASE: "testdb"
			MARIADB_USER: "testc"
			MARIADB_PASSOWRD: "testc"
			MARIADB_PASSWORD: "P@ssw0rd"
		ports:
		  - "3306:3306"
		    
	testapp:
		image: site:latest
		container_name: testapp
		restart: always
		environment:
			DB_TYPE: "maria"
			DB_HOST: "192.168.3.10" # BR-SRV
			DB_PORT: "3306"
		ports:
		  - "8080:8000"
```
Запускаем контейнер:
```bash
docker compose up -d
```
Проверяем:
```bash
curl -I http://192.168.3.10:8080
```

### Развертывания веб-приложения на HQ-SRV
```bash
apt-get update && apt-get install lamp-server -y
```
Примонтируем additional.iso:
```bash
mount /dev/sr0 /mnt
```
Копируем файлы:
```bash
cp /mnt/web/index.php /var/www/html
cp /mnt/web/logo.png /var/www/html
```
Переходим в конфигурацию `index.php`:
```bash
vim /var/www/html/index.php
Меняем следующее (в начале):
$servername = "localhost";
$username = "webc";
$password = "P@ssw0rd";
$dbname = "webdb";
```
Запускаем службу:
```bash
systemctl enable --now httpd2 mariadb
```
Создаем БД, пользователя и выдаем ему права, требуемые по заданию:
```bash
mysql -u root -e "CREATE DATABASE webdb; CREATE USER 'web'@'localhost' IDENTIFIED BY 'P@ssw0rd'; GRANT ALL PRIVILEGES ON webdb.* TO 'web'@'localhost'; FLUSH PRIVILEGES;"
```
Импортируем схемы и данные из файла `dump.sql`:
```bash
mysql -u web -pP@ssw0rd webdb < /mnt/web/dump.sql
```
Меняем права к файлам:
```bash
chown apache2:apache2 /var/www/html/
```
Перезапускаем службы:
```bash
systemctl restart mariadb
systemctl restart httpd2
```

### На маршрутизаторах конфигурируем статическую трансляцию портов
Во время выполнения задания использовались ALT Linux, с установленным NFTables. Было произведено дополнение блока table `ip nat {`, HQ-RTR:
```bash
chain prerouting {
iif "enp7s1" tcp dport 8080 dnat to 192.168.1.10:8080 # Порт смотрящий на ISP, а адрес - HQ-SRV
iif "enp7s1" tcp dport 2026 dnat to 192.168.1.10:2026
}
```
BR-RTR:
```bash
chain prerouting {
iif "enp7s1" tcp dport 8080 dnat to 192.168.3.10:8080 # Порт смотрящий на ISP, а адрес - BR-SRV
iif "enp7s1" tcp dport 2026 dnat to 192.168.3.10:2026
}
```
После чего, перезапустим службу:
```bash
systemctl restart nftables
```

### Настройка обратного прокси на ISP
```bash
apt-get update && apt-get install nginx -y
```
Переходим в конфигурационный файл:
```bash
vim /etc/nginx/sites-available.d/default.conf
```
Содержимое `default.conf`
```bash
server {
	listen 80;
	server_name docker.au-team.irpo;
	
	location / {
		proxy_pass http://192.168.3.10:8080;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme
	}
}
server {
	listen 80;
	server_name web.au-team.irpo;
	
	location / {
		proxy_pass http://192.168.1.10:8080;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme
	}
}
```
Символическая ссылка к файлу:
```bash
ln -s /etc/nginx/sites-available.d/default.conf /etc/nginx/sites-enabled.d/
```
Запускаем службу:
```bash
systemctl enable --now nginx
```

### Настройка web-based аутентификации на ISP
```bash
apt-get update && apt-get install apache2-htpasswd -y
```
Создаем пользователя WEB, добавляем информацию о нем в файл и задаем пароль:
```bash
htpasswd –c /etc/nginx/.htpasswd WEB
```
Возвращаемся в конфигурационный файл `default.conf`:
```bash
vim /etc/nginx/sites-available.d/default.conf
```
И в блок `web.au-team.irpo`:
```bash
		...
		auth_basic "Restricted Area";
		auth_basic_user_file /etc/nginx/.htpasswd
	}
}
```
Перезапускаем службу:
```bash
systemctl restart nginx
```