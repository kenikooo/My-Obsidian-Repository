‚Äî –ü–µ—Ä–µ–π—Ç–∏ –≤ [[HUB]] ‚Äî
> [!INFO] –ß—Ç–æ —Ç–∞–∫–æ–µ **Ansible**?
–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏, —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

---
### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—ã

> [!tldr] **–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã**
> 
> - `ansible` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç
> - `sshpass` ‚Äî –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–æ–ª—é –≤ SSH (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ –∏ —Ñ–∞–π–ª—ã

> [!info] **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤**
> 
> - `/etc/ansible/` ‚Äî –≥–ª–∞–≤–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥
> - `ansible.cfg` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
> - `hosts` ‚Äî —Ñ–∞–π–ª —Å –≥—Ä—É–ø–ø–∞–º–∏/–æ–±—ä–µ–∫—Ç–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
> - `group_vars/` ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥—Ä—É–ø–ø —Ö–æ—Å—Ç–æ–≤
> - `host_vars/` ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤
> - `group_vars/all.yml` ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤

Ansible –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SSH –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö. –í–∞–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–ø–æ—Å–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø–∞—Ä–æ–ª—å –∏–ª–∏ –∫–ª—é—á SSH).

---

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
ansible <group | object> -m <module> -a <arguments>

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–æ–≤
ansible all -m ping

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –≤ —É–¥–∞–ª—ë–Ω–Ω–æ–π –æ–±–æ–ª–æ—á–∫–µ
ansible all -m shell -a 'uptime'

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
ansible all -m copy -a 'src=/local/path dest=/remote/path'

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏—Å—Ç–µ–º–µ
ansible all -m setup -a 'filter=ansible_distribution'
```
–ó–∞–ø—É—Å–∫ Playbook:
```bash
ansible-playbook -i [–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å] –∏–º—è_–ø–ª–µ–π–±—É–∫–∞.yml

# –ü—Ä–∏–º–µ—Ä
ansible-playbook -i inventory.ini monitoring.yml
```

---

### –ü—Ä–æ—Å—Ç–æ–π Ansible.cfg
```bash
[defaults]
inventory = ./inventory.ini
host_key_checking = False
```
**–ü–æ—è—Å–Ω–µ–Ω–∏–µ**: `[defaults]` - —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏, –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∏–¥—É—â–∏–µ –Ω–∏–∂–µ, —è–≤–ª—è—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ "–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" –¥–ª—è —Ä–∞–±–æ—Ç—ã Ansible –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏;
`inventory = ./inventory.ini` - —Å—Ç—Ä–æ–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç Ansible, –≥–¥–µ –∏–º–µ–Ω–Ω–æ –∏—Å–∫–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤;
`host_key_checking = False` - —ç—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ SSH, –∫–æ—Ç–æ—Ä–∞—è —Å–∏–ª—å–Ω–æ —É–ø—Ä–æ—â–∞–µ—Ç –∂–∏–∑–Ω—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö. –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç? –ï—Å–ª–∏ 
`True`: –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ SSH —Å–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–≤–µ—Ä—è—Ç—å —ç—Ç–æ–º—É —É–∑–ª—É?" –∏ –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∏ –∫–ª—é—á –∏–∑–º–µ–Ω–∏–ª—Å—è, SSH –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ;
`False`:  Ansible –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∫–ª—é—á–µ–π —Ö–æ—Å—Ç–∞. –û–Ω –Ω–µ –±—É–¥–µ—Ç —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∏ –Ω–µ —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è.
–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ: –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –Ω–µ "–ø–æ–¥–≤–∏—Å" –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ `yes` –≤ –∫–æ–Ω—Å–æ–ª–∏
### –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (inventory)

> [!tip] **–§–∞–π–ª hosts** –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Ansible –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/etc/ansible/hosts`, –Ω–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –¥—Ä—É–≥–æ–π, —É–∫–∞–∑–∞–≤ `-i` –≤ –∫–æ–º–∞–Ω–¥–µ.

#### **–ü—Ä–∏–º–µ—Ä inventory.yml**

```yaml
all:
  children:
    webservers:
      hosts:
        web1:
          ansible_host: 192.168.33.11
          ansible_user: root
        web2:
          ansible_host: 192.168.33.12
          ansible_user: root
```

#### **–ü—Ä–∏–º–µ—Ä inventory.ini**
```ini
[haproxy_nodes]
Cloud-HA01 ansible_host=192.168.10.65
Cloud-HA02 ansible_host=192.168.10.66

[web_nodes]
Cloud-WEB01 ansible_host=192.168.10.67
Cloud-WEB02 ansible_host=192.168.10.68

[monitoring]
cloud-mon

[target_nodes]
cloud-adm

[all:vars]
ansible_user=altlinux
```
**–ü–æ—è—Å–Ω–µ–Ω–∏–µ**: `[haproxy_nodes]`, `[web_nodes]` –∏ —Ç–¥ - –≥—Ä—É–ø–ø—ã. –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –≥—Ä—É–ø–ø—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, —á—Ç–æ–±—ã –≤ –ø–ª–µ–π–±—É–∫–µ —Å–∫–∞–∑–∞—Ç—å "–£—Å—Ç–∞–Ω–æ–≤–∏ Nginx —Ç–æ–ª—å–∫–æ –Ω–∞ `[web_nodes]`";
`Cloud-HA01`, `Cloud-WEB01` - —ç—Ç–æ Inventory Name. –ò–º—è —Å–µ—Ä–≤–µ—Ä–∞ –≤–Ω—É—Ç—Ä–∏ Ansible;
`ansible_host=192.168.10.65` - –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, —É–∫–∞–∑—ã–≤–∞—é—â–∞—è —Ä–µ–∞–ª—å–Ω—ã–π IP –∏–ª–∏ DNS —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è;
`cloud-mon` - ansible_host –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ—ç—Ç–æ–º—É ansible –±—É–¥–µ—Ç –ø—Ä–æ–±–æ–≤–∞—Ç—å—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é –ø–æ –∏–º–µ–Ω–∏ (–æ–Ω–æ –¥–æ–ª–∂–Ω–æ —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ /etc/hosts –∏–ª–∏ DNS)
`[all:vars]` - –±–ª–æ–∫ –æ–±—â–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–ø–ø –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ:
- `ansible_user=altlinux` - –≥–æ–≤–æ—Ä–∏—Ç Ansible –∑–∞—Ö–æ–¥–∏—Ç—å –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º `altlinux`

---

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø –∏ —Ö–æ—Å—Ç–æ–≤

> [!example] **–ü—Ä–∏–º–µ—Ä `group_vars/all.yml`**

```yaml
ansible_user: admin
ansible_python_interpreter: /usr/bin/python3

# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –ø–∞—Ä–æ–ª—é
ansible_ssh_user: user
ansible_ssh_pass: password

# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –∫–ª—é—á—É
ansible_ssh_private_key_file: /home/user/.ssh/id_rsa
```

---

### Playbook (—Å—Ü–µ–Ω–∞—Ä–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏)

> [!quote] **Playbook** ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã—Ö –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö.

#### **–ü—Ä–æ—Å—Ç–µ–π—à–∏–π playbook**

```yaml
---
- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
  hosts: webservers
  become: yes  # –ó–∞–ø—É—Å–∫ –æ—Ç –∏–º–µ–Ω–∏ root
  tasks:
    - name: –û–±–Ω–æ–≤–∏—Ç—å –∫–µ—à –ø–∞–∫–µ—Ç–æ–≤
      apt:
        update_cache: yes

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Nginx
      apt:
        name: nginx
        state: present
```

#### **–ó–∞–ø—É—Å–∫**

```bash
ansible-playbook install_nginx.yml
```

---

### Jinja2 (–®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π)

> [!note] **Jinja2** ‚Äî —à–∞–±–ª–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ª–æ–≥–∏–∫—É –≤ —Ñ–∞–π–ª–∞—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

#### **–ü—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞** `nginx.conf.j2`

```jinja2
server {
    listen 80;
    server_name {{ ansible_fqdn }};
    location / {
        proxy_pass http://localhost:8080;
    }
}
```

#### **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ playbook**

```yaml
- name: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/default
```

---

### üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- üìñ [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Ansible](https://docs.ansible.com/)
- üì∞ [–û–±—É—á–µ–Ω–∏–µ –Ω–∞ Habr](https://habr.com/ru/articles/305400/)