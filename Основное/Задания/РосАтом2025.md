# Конкурсное задание III Чемпионата профессионального мастерства для студентов "СТУД-ИТ"
### Прежде чем начать
Прочитайте задание полностью. Обратите внимание на то, что задание написано не в хронологическом порядке, последовательность действий для выполнения задания остается на ваше усмотрение. Распределите время работы таким образом, чтобы заработать максимальное количество баллов. Во время выполнения задания руководствуйтесь следующими полезными советами:
- Если вам необходимо установить пароль, но в задании не указано, какой именно – установите P@ssw0rd.
- Если вы по каким-либо причинам хотите использовать свои собственные учетные данные/адреса/dns имена – **не забудьте указать их в форме, предоставленной организаторами по окончании соревновательных дней**.
- Внимательно проверяйте свою работу. Если эксперты не смогут подключится к чему-либо по какой-либо причине (сетевая недоступность, не подходят учетные данные) – **проверка этого устройства производится не будет.**
- Перед сдачей работы проверьте, что все устройства и сервисы переживают перезагрузку.
- Любые дополнительные комментарии и пожелания на проверку вы можете оставить для экспертов в предоставленной организаторами форме. Ваши комментарии гарантированно будут прочитаны перед проверкой или во время проверки.
- Если вы столкнулись с непониманием пункта задания – спросите.
- Вы можете расходовать ваше время так, как вам этого хочется. Помните, что время, затраченное на ваши нужды, не компенсируется, за исключением обеда и случаев проблем со стороны площадки.
- Если не указано иное, доступ к любому URL ожидается по стандартным портам.
- В качестве внешнего DNS-сервера используйте **10.150.1.1**, обслуживающего зону **tech.skills** и запросы на другие DNS-сервера
- Необходимые для выполнения работы материалы размещены на **files.atomarena.ru**
### Как оценивается работа

Каждый субкритерий имеет приблизительно одинаковый вес. Пункты внутри каждого критерия имеют разный вес, в зависимости от сложности пункта и количества пунктов в субкритерии.

Схема оценка построена таким образом, чтобы каждый пункт оценивался только один раз. Например, в секции «Базовая конфигурация» предписывается настроить имена для всех устройств, однако этот пункт будет проверен на трех случайных устройствах, одинаковых для каждого участника и определяемых группой проверки и оценен только 1 раз. Одинаковые пункты могут быть проверены и оценены больше, чем 1 раз, если для их выполнения применяются разные настройки или они выполняются на разных классах устройств.

### В L3 топологии есть ошибка: Сервер BR-SRV1 Должен иметь адрес 192.168.2.100, BR-SRV2 -- 192.168.2.200. Внутренний адрес BR-RTR -- 192.168.2.1

**На выполнение работы даётся 15 часов.**
**Желаем успехов!**

---------------

#### ПОДГОТОВКА ИНФРАСТРУКТУРЫ

Сконфигурируйте базовые параметры виртуальных машин для обеспечения идентификации и сетевой связанности. Обязательно должно быть **настроено полное доменное имя** и **IP** **адрес** согласно топологии. Окружение виртуальных машин, такое как оболочки, текстовые редакторы, графический интерфейс и прочее не является обязательным и остается на усмотрение участника.

Виртуальные машины должны иметь возможность связываться друг с другом по доменным именам. Перед сдачей работы на проверку убедитесь, что с **каждой** виртуальной машины возможен доступ по доменному имени к любому сервису предприятия или к любой другой виртуальной машине.

На каждую виртуальную машину обеспечьте доступ по протоколу SSH с использованием парольной аутентификации для обычного пользователя, созданного по умолчанию. Доступ до виртуальных машин с использованием пользователя **root** должен быть **запрещен**. Если вам необходимо разрешить доступ под пользователем root – запретите парольный доступ и используйте сгенерированную вами пару ключей. Ключи следует расположить в стандартной директории.

**Обеспечьте наличие на каждой клиентской машине утилит `curl`, `wget` и `host`.**

#### НАСТРОЙКА СЕТЕВОЙ СВЯЗАННОСТИ

1. Сконфигурируйте DHCP сервер на пограничном маршрутизаторе офиса **BR** в соответствии с требованиями:
	1. Диапазон выдаваемых адресов: **192.168.2.50-192.168.2.99**.
	2. Шлюз по умолчанию: адрес пограничного маршрутизатора.
	3. DNS сервер: адрес **BR-SRV1**.
	4. Клиентский компьютер **BR-CLI** должен получать адрес по DHCP.
	5. В качестве пакета используйте isc-dhcp-server.
2. Выполните настройку DNS сервера на **CR-SRV**. 
	1. Сконфигурируйте зону **stud.skills**, записи добавьте согласно приложению 1. 
	2. Все запросы к неизвестным зонам должны быть перенаправлены на сервер **10.150.1.1**. 
	3. Сконфигурируйте подчиненный DNS сервер на **BR-SRV1**.
	4. Обеспечьте автоматическое обновление записи **BR-CLI** при смене IP-адреса.
		- Обновлятся должна как прямая, так и обратная зона.
3. На пограничных маршрутизаторах выполните настройку межсетевого экрана, с использованием пакета **nftables**.
	1. Все устройства обоих офисов должны иметь доступ в Интернет.
	2. Запретите трафик для всех портов и протоколов, кроме необходимых для корректной работы инфраструктуры.
	3. Запретите icmp трафик на пограничные маршрутизаторы из вешних сетей. Трафик из внутренних сетей обоих офисов **должен быть разрешен**.
	4. Обеспечьте доступ по SSH к серверу **CR-SRV** из внешних сетей. В качестве внешнего порта используйте **2222** на маршрутизаторе **CR-RTR**.
4. Выполните передачу ssh ключей с **OUT-CLI** на **CR-SRV**, для обеспечения беспарольной аутентификации при подключении на порт 2222 маршрутизатора CR-RTR. 
	1. Пользователь root на **OUT-CLI** должен иметь возможность беспарольного входа на **CR-SRV** под учетной записью пользователя administrator.
5. Для передачи данных между офисами организовано **защищенное** VPN соединение с использованием GRE и Strongswan. 
	1. Необходимо восстановить работоспособность соединения. 
	2. Соединение должно быть **защищено**. 
	3. Для организации маршрутизации используйте протокол OSPF, реализованный пакетом FRR.
6. На маршрутизаторе **CR-RTR** сконфигурируйте сервер удаленного доступа Wireguard.
	1. В качестве клиента используйте **OUT-CLI**.
	2. Клиент должен устанавливать соединение при загрузке ОС и иметь доступ ко всем ресурсам **обоих офисов** с использованием **DNS имен**.
7. Для подключения **OUT-CLI** к интернету настройте PPPoE соединение с провайдером. Используйте логин **pppoeuser** и пароль **pppoepass** для аутентификации.

#### НАСТРОЙКА СЕРВИСОВ ЦЕНТРАЛИЗОВАННОГО УПРАВЛЕНИЯ

1. На CR-SRV разверните службу каталога на базе ALD Pro для домена **stud.skills**. 
	1. Пользователей необходимо импортировать из файла **users.csv**.
		1. В качестве пароля всем пользователям установите **P@ssw0rd**
		2. При необходимости смены пароля при входе используйте **P@ssw0rd1**
	2. Все машины с префиксом **-CLI** в названии должны иметь возможность аутентификации через ALD Pro.
	3. Обеспечьте доступ к WEB интерфейсу ALD Pro по имени **ald.stud.skills**. В качестве административной учетной записи используйте **admin** с паролем **P@ssw0rd**.
	4. Сконфигурируйте права пользователей следующим образом:
		1. На **BR-CLI** могут аутентифицироваться **только** пользователи группы **branch** и локальные пользователи.
		3. На **OUT-CLI** имеют право аутентифицироваться **только** пользователи группы **remotes** и локальные пользователи
		4. Пользователи группы **main** должны иметь возможность повышать привилегии с использованием **sudo**. У других **доменных** пользователей такой возможности быть **не должно**.
		5. Пользователи группы **branch** должны иметь возможность повышать привилегии для выполнения ограниченного набора команд: cat, grep, head, tail, id.
		6. Все пользователи, которым разрешен доступ к sudo должны иметь возможность выполнения команд с повышенными привилегиями без ввода пароля.
	5. Для всех пользователей домена должны быть реализованы общие каталоги.
		1. Каталог **Share**: все пользователи имеют права для чтения и записи в данный каталог. При этом, удалять файлы из этого каталога могут **только владельцы файлов**. Каталог должен быть смонтирован на рабочий стол всех доменных пользователей.
		2. Каталог **Docs**: доступ для чтения и записи имеет **только группа** **branch**. Остальные пользователи имеют доступ в формате **read** **only**. Каталог должен быть смонтирован на рабочий стол всех доменных пользователей.
		3. Для размещения каталогов используйте сервер CR-SRV
			- Каталог share должен быть доступен по пути /opt/share/
			- Каталог docs должен быть доступен по пути /opt/docs/
			- Убедитесь, что каталоги на момент проверки не пусты
	6. Реализуйте механизм инвентаризации машин с префиксом **CLI** в названии через Ansible на BR-SRV1:
		1. Плейбук должен собирать информацию о рабочих местах:
			- Имя компьютера
			- IP-адрес компьютера
		2. Рабочий каталог ansible должен располагаться в **/etc/ansible**
		3. Отчеты, собранные с машин, разместите в папке **reports** рабочего каталога Ansible. 
			1. Используйте формат **.yml**.
			2. Имя файла должно совпадать с именем хоста, с которого собрана информация.
			3. Убедитесь, что на момент проверки присутствует хотя-бы один файл журнала.
		4. Файл с плейбуком должен быть доступен по пути `/etc/ansible/get_info.yml`
		5. В качестве inventory файла используйте `/etc/ansible/inventory.yml`
			- Вся необходимая для подключения информация должна содержаться в этом файле.

#### НАСТРОЙКА СЕРВИСОВ

1. Реализуйте центр сертификации на сервере **CR-SRV**. 
	1. В качестве CN укажите **STUD-CA**. 
	2. Все хосты должны доверять данному центру сертификации на уровне системы, для работы утилит **curl** и **wget**. На клиентских ПК дополнительно необходимо обеспечить доверие к сертификату браузера **firefox** для **всех** пользователей. 
	3. Все сервисы, предусматривающие доступ через web-браузер, должны быть защищены с использованием сертификатов от данного центра сертификации (исключением является ALD Pro, веб интерфейс ALD Pro защищать сертификатом необязательно).
	4. Все данные центра сертификации должны быть расположены в директории `/etc/ca`
	5. Корневой сертификат должен быть доступен по пути `/etc/ca/cacert.pem`
2. На сервере **BR-SRV2** реализуйте централизованный сбор журналов.
	1. Журналы необходимо собирать с устройств CR-RTR и BR-RTR, в директорию **/opt/logs/\<hostname\>.log**. 
	2. Настройте ротацию логов: при достижении объёма в **10МБ** журнал следует сжимать файл журнала. Выполнять ротацию следует **раз в минуту**. 
	3. Сконфигурируйте web сервер для доступа к файлам журналов.
		1. По ссылке https://logs.stud.skills пользователь должен видеть все содержимое папки **/opt/logs** и иметь возможность скачать любой из журналов. 
		2. При попытке подключения по IP адресу пользователь должен получать ошибку 404. 
		3. При попытке доступа по http должно происходить перенаправление на https.
		4. Защитите доступ к сайту с использованием базовой аутентификации, в качестве логина используйте **logadmin**, в качестве пароля – **logpass**.
3. Разверните оркестратор **Docker Compose** на хосте **BR-SRV1** для управления следующими сервисами:
	1. СУБД PostgresSQL
		1. Создайте базу данных **university**.
		2. Создайте структуру БД:
			1. Таблица **marks** - входит в группу таблиц **learning**.  
			2. Таблица **students** - входит в группу таблиц **public**
			3. Таблица **attendance** - входит в группу таблиц **accounting**
			4. Таблица **subjects** - входит в группу таблиц **learning**
			5. Таблица **reasons** - входит в группу таблиц **accounting**
		3. Создайте роли и пользователей, назначьте права на таблицы и группы:
			1. Роль **student** - доступ только на чтение записей группы таблиц **learning**. Пользователь - **sidorov**
			2. Роль **teacher** - доступ на создание и обновление записей таблиц **marks**, **reasons** и **attendance**. Пользователь - **petrov**
			3. Роль **administration** - полный доступ ко всем таблицам БД. Пользователь - **smirnov**
		4. Для создания таблиц используйте дамп **database.sql**
		5. В качестве паролей пользователей используйте **P@ssw0rd**
		6. Обеспечьте на BR-SRV1 наличие клиента для подключения к postgresql
	2. Прямой прокси-сервер SQUID
		1. Прокси-сервер должен быть доступен по URL http://proxy.stud.skills:8081
		2. Сконфигурируйте хост **BR-CLI** для использования данного прокси-сервера при доступе к ресурсам для всех пользователей домена. 
		3. Необходимо обеспечить использование прокси только браузером Firefox, причём настройка должна применяться для всех пользователей, в том числе и доменных.
		4. Настройте ограничения доступа к прокси-серверу:
			1. Доступ к сайту **site2.tech.skills** должен быть ограничен для всех клиентских хостов филиала.
			2. Доступ к сайту **site1.tech.skills** должен предоставляться только после авторизации по логину и паролю. Используйте локальную базу данных пользователей.
			3. Создайте пользователя `mikhail` с паролем `proxypass`. Данный пользователь должен получать доступ к сайту site1.tech.skills.
	3. Приложение на Python
		1. Выполните подготовку окружения с зависимостями. Используйте Python 3.12.
		2. Приложение должно быть доступно по адресу https://api.stud.skills:8443.
		3. Разверните два экземпляра приложения с реализацией балансировки при помощи HAProxy.
		4. Наименование экземпляра укажите в переменной окружения INSTANCE_ID.
		5. Исходный код приложения изменять нельзя.
	4. Сервисы должны быть доступны даже после перезагрузки хоста.
	5. В качестве рабочей директории используйте /opt/compose/

## По окончании выполнения задания

Все виртуальные машины будут перезагружены путем симуляции сбоя по питанию. Сначала будут перезагружены сервера, затем клиенты. Позабодьтесь о том, чтобы после перезагрузки инфраструктура была живой.

***Список имён DNS***

| Имя                      | Тип   | Адрес                                    |
| ------------------------ | ----- | ---------------------------------------- |
| \<hostname\>.stud.skills | А, PTR     | Адрес машины (для всех ВМ, кроме WIN-AD) |
| api.stud.skills          | CNAME | BR-SRV2                                  |
| logs.stud.skills         | CNAME | BR-SRV2                                  |
| proxy.stud.skills        | CNAME | BR-SRV2                                  |
| ald.stud.skills          | CNAME | CR-SRV                                   |

***Используемые версии ОС***

| Имя хоста               | Операционная система  |
| ----------------------- | --------------------- |
| *-CLI                   | Astra Linux 1.8.1 GUI |
| CR-DB, BR-SRV1, BR-SRV2 | Astra Linux 1.8.1 CLI |
| CR-RTR, BR-RTR, ISP     | Debian 12.5           |
| CR-SRV                  | Astra Linux 1.7.5 CLI |
| WIN-AD                  | Windows Server 2022   |

***Топология L1***

![Топология L1](/L1.png)

***Топология L3***
![Топология L3](/L3.png)
