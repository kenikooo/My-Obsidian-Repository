На каждом устройстве:
```bash
hostnamectl set-hostname srv1-cod.cod.ssa2025; exec bash
```
### Подготовка дисков (на всех устройствах):
v. Создайте на каждом диске файловую систему xfs с оптимизацией для больших файлов, используйте опции -i size=512 -n size=8192:
```bash
for dev in sdb sdc sdd; do
  mkfs.xfs -f -i size=512 -n size=8192 /dev/$dev
done
```

Смонтируйте файловые системы:
1.    Наsrv1-cod: в /mnt/minio-data-node1-1, /mnt/minio-data-node1-2, /mnt/minio-data-node1-3.
```bash
# Пример для srv1 (пример создания не через скрипт)
mkdir -p /mnt/minio-data-node1-{1,2,3}
```
2.    Аналогично для других серверов (/mnt/minio-data-nodeX-Y).

vii. Настройте автоматическое монтирование при загрузке системы на всех серверах с использованием UUID в /etc/fstab:
a. Запустите службу MinIO на всех четырех серверах как часть единого кластера.
b. Используйте стандартный порт 9000 для API на каждом узле.
c. Используйте стандартный порт 9001 для веб-интерфейса Console на каждом узле.
d. Установите общие учетные данные root пользователя для всего кластера:
i. Имя пользователя: minioadmincluster
ii. Пароль: P@ssw0rd2025
e. Настройте MinIO на каждом узле для использования соответствующих каталогов в качестве хранилища /mnt/minio-data-node1-{1,2,3} на srv1-cod.
```bash
NODE_ID=1 # Номер узла
DRIVES=(sdb sdc sdd)

for i in "${!DRIVES[@]}"; do
  DEV="/dev/${DRIVES[$i]}"
  MNT="/mnt/minio-data-node${NODE_ID}-$((i+1))"
  mkdir -p "$MNT"
  mkfs.xfs -f "$DEV"
  UUID=$(blkid -s UUID -o value "$DEV")
  if [ -n "$UUID" ]; then
    echo "UUID=$UUID $MNT xfs defaults,noatime 0 2" >> /etc/fstab
  fi
done

# Монтирование и проверка
mount -a
df -h | grep minio
```
b. Установите и настройте сервер MinIO в distributed mode:
```bash
apt-get update && apt-get install minio -y
```
Запуск службы:
```bash
systemctl enable --now minio
```
Настройка minio:
```bash
MINIO_VOLUMES="http://srv{1...4}-cod.cod.ssa2025/mnt/minio-data-node{1...4}-{1...3}"
MINIO_ADDRESS=":9000"
MINIO_CONSOLE_ADDRESS=":9001"
MINIO_ROOT_USER=minioadmincluster
MINIO_ROOT_PASSWORD=P@ssw0rd2025
MINIO_SERVER_URL="http://srv1-cod.cod.ssa2025"
MINIO_BROWSER_REDIRECT_URL="http://srv1-cod.cod.ssa2025"
```

```bash
# Перезапускаем службу
systemctl daemon-reload
systemctl restart minio

# Проверяем статус
systemctl status minio

# Включаем автозагрузку
systemctl enable minio
```

f. Обеспечьте повышенную отказоустойчивость кластера:
i. Потеря до двух узлов не должна приводить к потере данных и должна позволять продолжить работу в degraded mode.
ii. Настройте автоматическое восстановление данных при возврате узла.
iii. Внедрите bucket replication между двумя подкластерами, srv1+srv2 и srv3+srv4 для гео-распределения.
```bash
apt-get install minio-mc
```
Настроим алиас:
```bash
mc alias set mycluster http://srv1-cod:9000 minioadmincluster P@ssw0rd2025
```
Включаем версионирование для корзины:
```bash
mc version enable mycluster/mybucket
```

### Настройка /etc/hosts (на всех 4 узлах)
```bash
# Заменить IP на адреса ВМ
192.168.20.11 srv1-cod.cod.ssa2025 srv1-cod
192.168.20.12 srv2-cod.cod.ssa2025 srv2-cod
192.168.20.13 srv3-cod.cod.ssa2025 srv3-cod
192.168.20.14 srv4-cod.cod.ssa2025 srv4-cod
```

### Создание CA на srv1-cod
a. Выпустите отдельные сертификаты для каждого узла кластера с использованием центра сертификации на `srv1-cod` для:
i. srv1-cod.cod.ssa2025
ii. srv2-cod.cod.ssa2025
iii. srv3-cod.cod.ssa2025
iv. srv4-cod.cod.ssa2025
b. Настройте MinIO на всех узлах для использования соответствующих выпущенных сертификатов для шифрования всех соединений (TLS).
c.  Настройте MinIO для использования только TLS-соединений для API и Console.

```bash
# Создаем директорию
mkdir ~/minio-ca && cd ~/minio-ca
# Генерируем корневой ключ и сертификат
openssl genrsa -out ca.key 2048
openssl req -new -x509 -days 3650 -key ca.key -out ca.crt \
    -subj "/CN=SSA-Root-CA"
```
Выпуск сертификатов для узлов (выполнить для каждого srvX):
```bash
for i in {1..4}; do
  NAME="srv$i-cod.cod.ssa2025"
  # 1. Создаем ключ узла
  openssl genrsa -out $NAME.key 2048
  # 2. Создаем запрос и подписываем его нашим ca.crt
  openssl req -new -key $NAME.key -out $NAME.csr -subj "/CN=$NAME"
  openssl x509 -req -in $NAME.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
    -out $NAME.crt -days 365 -extfile <(echo "subjectAltName=DNS:$NAME")
done
```
На каждом srv, создаем структуру папок:
```bAsh
mkdir -p /etc/minio/certs/CAs
```
Передаем созданные сертификаты (с srv1-cod):
```bash
# Пример передачи с srv1 на srv2
scp ca.crt srv2-cod.cod.ssa2025.crt srv2-cod.cod.ssa2025.key root@srv2-cod:/etc/minio/certs/
```
На SRV2 переименовываем файлы в _public.crt_ и _private.key_:
```bash
cd /etc/minio/certs/
# Свой сертификат узла -> в public.crt
mv srv2-cod.cod.ssa2025.crt public.crt
# Свой ключ узла -> в private.key
mv srv2-cod.cod.ssa2025.key private.key
# Корневой сертификат -> в папку CAs
mv ca.crt CAs/public.crt

```
Настройка конфига (/etc/sysconfig/minio):
```bash
Расскоментировать MINIO_OPTIONS
```
Задаем права доступа
```bash
chown -R minio:minio /etc/minio/certs
chmod 600 /etc/minio/certs/private.key
chmod 644 /etc/minio/certs/public.crt
```
Перезапуск кластера:
```bash
systemctl restart minio
```
Проверка:
```bash
1) Заходим в браузере на https://srv1-cod.cod.ssa2025:9001.
2) Если браузер ругается на "Self-signed certificate" — значит, TLS работает. Нажимаем "Advanced" -> "Proceed", чтобы войти.
3) Проверяем статус в консоли:
> mc alias set mytls https://srv1-cod.cod.ssa2025:9000 minioadmincluster P@ssw0rd2025.
```

a. Создайте тестовый бакет с именем test-cluster-bucket с включенной версионностью и политикой retention (7 дней).

b. Загрузите несколько тестовых объектов минимум 10 в созданный бакет.

c. Убедитесь, что объект доступен через любой узел кластера.

d. Проверьте доступность веб-интерфейса Console через TLS.

e. Проверьте доступность API через TLS

Настройка доступа (Алиас):
```bash
mc alias set mytls https://srv1-cod.cod.ssa2025:9000 minioadmincluster P@ssw0rd2025ash
```
Создание бакета и настройка политик:
```bash
# Создание бакета
mc mb mytls/test-cluster-bucket
# Включение версионности
mc version enable mytls/test-cluster-bucket
# Настройка Retention (7 дней)
mc retention set --default compliance 7d mytls/test-cluster-bucket
```
Загрузка тестовых объектов:
```bash
for i in {1..10}; do touch "file$i.txt"; done
mc cp file*.txt mytls/test-cluster-bucket/
```
Проверка доступности:
```bash
# через API (любой узел)
mc ls https://srv4-cod.cod.ssa2025
```